#!/bin/bash
set -e

releaseVersion=$1

currentDir=$(node -e "console.yellowLog(require('path').dirname(require('fs').realpathSync('$BASH_SOURCE')))")
source $currentDir/helper


# Help messages
if [ "x$1" = "x" ]; then
  yellowLog "This script will create a new tag to finalize a release branch."
  yellowLog "Argument 1 (MUST)     : <release-version> to create f.e. 10.0.0"
  exit 1
fi


# Does the package.json exist?
if ! [ -f "./package.json" ]; then
  yellowLog 'ERR: You must run the script from the project root.'
  exit 1
fi


# Are there uncommited changes?
hasUncommitedChanges=$(git diff)
if [[ $hasUncommitedChanges ]]; then
  yellowLog "ERR: You have uncommited changes."
  exit 1
fi

# Is there a local release branch with the same name?
localBranchExists=$(git branch -l | { grep "release-$releaseVersion\$" || true; })
if [ "x$localBranchExists" != "x" ]; then
  yellowLog "ERR: There is a local branch with the name release-$releaseVersion,
    please delete this branch before executing the script"
  exit 1
fi

# Stop if there is no remote release branch
remoteBranchExists=$(git branch -r | { grep "release-$releaseVersion\$" || true; })
if [ "x$remoteBranchExists" = "x" ]; then
  yellowLog "ERR: There is no remote branch release-$releaseVersion.
    Please execute 'init-release' first"
  exit 1
fi


yellowLog "checkout release branch release-$releaseVersion"
git fetch --all
git checkout "release-$releaseVersion"


yellowLog "Update release version in package.json"
cat package.json | jq ".release=\"$releaseVersion\"" > package.json.tmp
mv package.json.tmp package.json
git add package.json
git diff --quiet --exit-code --cached || git commit -am "Updated version to $releaseVersion"


yellowLog "Create tag $releaseVersion"
git tag -am "Release $releaseVersion" "$releaseVersion"


yellowLog "Push release and tag to release-$releaseVersion"
git push --tags origin "release-$releaseVersion"


yellowLog "finish-release.sh has been executed successfully"
